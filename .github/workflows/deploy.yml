# GitHub Actions CI/CD íŒŒì´í”„ë¼ì¸ ì„¤ì • íŒŒì¼
# PR ìš”ì²­ ì‹œ: í…ŒìŠ¤íŠ¸ + ì»¤ë²„ë¦¬ì§€ ì²´í¬ë§Œ ìˆ˜í–‰
# main, develop ë¸Œëœì¹˜ë¡œ push ì‹œ: ECRì— ì´ë¯¸ì§€ ì—…ë¡œë“œ + ECS ë°°í¬ê¹Œì§€ ì „ì²´ ìŠ¤íƒ­ ì‹¤í–‰

name: CI/CD to ECS with SHA Tag

on:
  push:
    branches: [main, develop]  # ìš´ì˜, ê°œë°œ ë¸Œëœì¹˜ push ì‹œ ì „ì²´ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
  pull_request:
    branches: [main, develop]  # PR ì‹œ í…ŒìŠ¤íŠ¸ë§Œ ìˆ˜í–‰

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # ê³µí†µ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    env:
      ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
      ECR_REPOSITORY: ${{ (github.ref_name == 'main' && 'prod/team6-monew') || (github.ref_name == 'develop' && 'dev/team6-monew') }}
      IMAGE_TAG: ${{ github.sha }}

    steps:
      # 0. push ì´ë²¤íŠ¸ ë°œìƒ ì‹œ, ì–´ë–¤ ECR ë¦¬í¬ì§€í† ë¦¬ì— ì–´ë–¤ íƒœê·¸ì˜ ì´ë¯¸ì§€ê°€ ë°°í¬ë˜ëŠ”ì§€ ì¶œë ¥í•´ì¤Œ
      - name: Show image info
        if: github.event_name == 'push'
        run: echo "ğŸš€ Deploying to $ECR_REPOSITORY with tag $IMAGE_TAG"
        
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout source code
        uses: actions/checkout@v4

      # # 2. JDK 17 ì„¤ì •
      # - name: Set up JDK 17
      #   uses: actions/setup-java@v3
      #   with:
      #     java-version: '17'
      #     distribution: 'temurin'

      # # 3. gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      # - name: Grant permission to gradlew
      #   run: chmod +x ./gradlew

      # # 4. í…ŒìŠ¤íŠ¸ ë° ì»¤ë²„ë¦¬ì§€ ì²´í¬ (PR & Push ê³µí†µ)
      # - name: Run tests and coverage check
      #   run: ./gradlew clean test jacocoTestReport jacocoTestCoverageVerification

      # # 5. Codecov ì—…ë¡œë“œ (ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸)
      # - name: Upload coverage to Codecov
      #   uses: codecov/codecov-action@v5
      #   with:
      #     token: ${{ secrets.CODECOV_TOKEN }}
      #     files: build/reports/jacoco/test/jacocoTestReport.xml

      # === ì•„ë˜ ë‹¨ê³„ëŠ” Push ì´ë²¤íŠ¸ì¼ ë•Œë§Œ ì‹¤í–‰ë¨ ===
      # 6-1. AWS ì¸ì¦ (ìš´ì˜)
      - name: Configure AWS credentials (PROD)
        if: github.event_name == 'push' && github.ref_name == 'main'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 6-2. AWS ì¸ì¦ (ê°œë°œ)
      - name: Configure AWS credentials (DEV)
        if: github.event_name == 'push' && github.ref_name == 'develop'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_DEV }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_DEV }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 7. ECR ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        if: github.event_name == 'push'
        uses: aws-actions/amazon-ecr-login@v2

      # 8. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR ì—…ë¡œë“œ
      - name: Build & Push Docker image
        if: github.event_name == 'push'
        run: |
          docker build --platform linux/amd64 --provenance=false -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

     # 9. Task Definition ë Œë”ë§
      - name: Render ECS task definition
        if: github.event_name == 'push'
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: ${{ (github.ref_name == 'main' && 'ecs/prod/task-definition.json') || (github.ref_name == 'develop' && 'ecs/dev/task-definition.json') }}
          container-name: ${{ (github.ref_name == 'main' && 'team6-monew-prod-container') || (github.ref_name == 'develop' && 'team6-monew-dev-container') }}
          image: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}

      # 10. ECS ì„œë¹„ìŠ¤ì— ìƒˆ Task ì ìš© (ë¬´ì¤‘ë‹¨ ë°°í¬)
      - name: Deploy to ECS
        if: github.event_name == 'push'
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: task-definition.json
          cluster: ${{ (github.ref_name == 'main' && 'team6-monew-prod-cluster') || (github.ref_name == 'develop' && 'team6-monew-dev-cluster') }}
          service: ${{ (github.ref_name == 'main' && 'team6-monew-prod-service') || (github.ref_name == 'develop' && 'team6-monew-dev-service') }}
          wait-for-service-stability: true
